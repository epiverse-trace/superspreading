---
title: "Estimate individual-level transmission"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Estimate individual-level transmission}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

In their seminal work @lloyd-smithSuperspreadingEffectIndividual2005 showed
that variation in individual-level disease transmission exceed that of a poisson
model and in some cases that of a geometric model. They fit a negative binomial
distribution to show that the distribution of secondary cases displayed overdispersion,
in other words the variance exceeded the mean. In the negative binomial distribution
this is quantified by the dispersion ($k$) parameter being less than 1.

This vignette demonstrates how to use the {superspreading} and {fitdistrplus} R
packages to estimate the parameters of individual-level transmission and select
the best fitting model.

```{r setup}
library(superspreading)
library(fitdistrplus)
```

For this example we use tranmission chain data from @fayeChainsTransmissionControl2015 from the Ebola virus disease outbreak in West Africa from February to August 2014. Specifically, this data reconstructs the pathway of Ebola transmission in Conakry, Guinea.

This data has been used by @althausEbolaSuperspreading2015 to show that the Ebola outbreak in Conakry displayed signatures of overdispersion (i.e. superspreading events), and by @kucharskiEffectivenessRingVaccination2016 to determine the effectiveness of ring- and mass-vaccination campaigns for ongoing Ebola outbreaks.

## Transmission data

```{r}
# total number of cases (i.e. individuals in transmission chain)
n <- 152

# number of secondary cases for all cases
all_cases_transmission <- c(
  1, 2, 2, 5, 14, 1, 4, 4, 1, 3, 3, 8, 2, 1, 1, 4, 9, 9, 1, 1, 17, 2, 1, 
  1, 1, 4, 3, 3, 4, 2, 5, 1, 2, 2, 1, 9, 1, 3, 1, 2, 1, 1, 2
)

# add zeros for each cases that did not cause a secondary case (i.e. did not transmit)
all_cases <- c(all_cases_transmission, rep(0, n - length(all_cases_transmission)))

# fit a standard set of offspring distribution models:
# - Poisson
# - Geometric
# - Negative Binomial

# TODO: use {quickfit} for model comparison
pois_fit <- fitdistrplus::fitdist(data = all_cases, distr = "pois")
geom_fit <- fitdistrplus::fitdist(data = all_cases, distr = "geom")
nbinom_fit <- fitdistrplus::fitdist(data = all_cases, distr = "nbinom")
knitr::kable(
  data.frame(
    distribution = c(pois_fit$distname, geom_fit$distname, nbinom_fit$distname),
    AIC = c(pois_fit$aic, geom_fit$aic, nbinom_fit$aic),
    BIC = c(pois_fit$bic, geom_fit$bic, nbinom_fit$bic)
  )
)
```

The best fit model, for both AIC and BIC comparison, is the negative binomial.

```{r}
nbinom_fit$estimate
```

The parameter for the negative binomial show that there is overdispersion in
transmission and thus the EVD transmission chain data shows that superspreading
events are possible realisation of EVD transmission dynamics.

These values match those reported in @althausEbolaSuperspreading2015 and here 
we reproduce figure 1 from that paper to display the tail of the distribution
from which superspreading events can be possible.

```{r}
# TODO: could use ggplot to polish
plot(
  x = seq(0, 20, 1), 
  y = dnbinom(
    x = seq(0, 20, 1), 
    size = nbinom_fit$estimate[["size"]], 
    mu = nbinom_fit$estimate[["mu"]]
  ), 
  xlab = "Number of secondary cases", 
  ylab = "Frequency", 
  type = "b"
)
barplot(
  height = dnbinom(
    x = seq(0, 20, 1), 
    size = nbinom_fit$estimate[["size"]], 
    mu = nbinom_fit$estimate[["mu"]]), 
  width = 1, 
  xlab = "Number of secondary cases", 
  ylab = "Frequency"
)

```

Next we partitioned the data into index cases and secondary cases following @kucharskiEffectivenessRingVaccination2016.

```{r}
index_case_transmission <- c(2, 17, 5, 1, 8, 2, 14)
secondary_case_transmission <- c(
  1, 2, 1, 4, 4, 1, 3, 3, 1, 1, 4, 9, 9, 1, 2, 1, 1, 1, 4, 3, 3, 4, 2, 
  5, 1, 2, 2, 1, 9, 1, 3, 1, 2, 1, 1, 2
) 


# Format data into index and non-index cases

# total non-index cases
n_non_index <- sum(c(index_case_transmission, secondary_case_transmission)) 
# transmission from all non-index cases
non_index_cases <- c(secondary_case_transmission, rep(0, n_non_index - length(secondary_case_transmission))) 


# Estimate R and k for index and non-index cases
param_index <- fitdistrplus::fitdist(data = index_case_transmission, distr = "nbinom") 
param_index
param_non_index <- fitdistrplus::fitdist(data = non_index_cases, distr = "nbinom") 
param_non_index
```

## Superspreading using alternative distributions

::: {.alert .alert-primary}
**Advanced options** 

This section of the vignette discusses some alternative transmission models to 
quantify overdispersion and may be considered advanced in comparison to the above
example.
:::

Research subsequent to @lloyd-smithSuperspreadingEffectIndividual2005 has shown that 
contact data from infectious disease outbreaks often shows signatures of overdispersion and can therefore cause superspreading events. However, overdispersion can be modelled by other distributions to the negative
binomial. 

@kremerQuantifyingSuperspreadingCOVID192021 showed for SARS-CoV-2 that superspreading
may be better modelled by a Poisson mixture distribution (or Poisson compound distribution).
Four Poisson mixture distribution were applied: Poisson-Gamma, Poisson-Lognormal, Poisson-Weibull,
and Poisson-Generalised-Gamma; finding the Poisson-lognormal and Poisson-weibull fit best
for three data sets.

::: {.alert .alert-warning}
The Poisson-Gamma distribution is the same as the negative binomial distribution. 
Hereafter we refer to it is the negative binomial.
:::

R has the density functions and cumulative distribution functions for the Poisson 
(`dpois()` and `ppois()`), Geometric (`dgeom()` and `pgeom()`) and Negative binomial
(`dnbinom()` and `pnbinom()`), but does not supply either for Poisson compound 
distributions. In the {superspreading} R package we supply the density and cumulative
distribution functions for the Poisson-lognormal (`dpoislnorm()` and `ppoislnorm()`) 
and Poisson-weibull (`dpoisweibull()` and `ppoisweibull()`).

These functions can be used with {fitdistrplus}, as shown for the other distributions above.

```{r}
# fit an expanded set of offspring distribution models:
# - Poisson
# - Geometric
# - Negative Binomial
# - Poisson-lognormal compound
# - Poisson-Weibull compound

# TODO: use {quickfit} for model comparison
pois_fit <- fitdistrplus::fitdist(data = all_cases, distr = "pois")
geom_fit <- fitdistrplus::fitdist(data = all_cases, distr = "geom")
nbinom_fit <- fitdistrplus::fitdist(data = all_cases, distr = "nbinom")
poislnorm_fit <- fitdistrplus::fitdist(
  data = all_cases, 
  distr = "poislnorm", 
  start = list(meanlog = 1, sdlog = 1)
)
poisweibull_fit <- fitdistrplus::fitdist(
  data = all_cases, 
  distr = "poisweibull", 
  start = list(shape = 1, scale = 1)
)

knitr::kable(
  data.frame(
    distribution = c(pois_fit$distname, geom_fit$distname, nbinom_fit$distname, poislnorm_fit$distname, poisweibull_fit$distname),
    AIC = c(pois_fit$aic, geom_fit$aic, nbinom_fit$aic, poislnorm_fit$aic, poisweibull_fit$aic),
    BIC = c(pois_fit$bic, geom_fit$bic, nbinom_fit$bic, poislnorm_fit$bic, poisweibull_fit$bic)
  )
)
```

